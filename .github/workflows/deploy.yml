name: Deploy to Azure

on:
  release:
    types: [published]

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  environment: prod    
  provision:
    uses: ./.github/workflows/provision-infra.yml
    with:
      resource_group: ${{ vars.AZURE_RESOURCE_GROUP }}
      location: ${{ vars.AZURE_LOCATION || 'swedencentral' }}
      deployment_name: pacman-deployment
      postgres_location: ${{ vars.AZURE_POSTGRES_LOCATION || 'swedencentral' }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}

  build-and-deploy:
    needs: provision
    uses: ./.github/workflows/build-image.yml
    with:
      acr_login_server: ${{ needs.provision.outputs.acr_login_server }}
      acr_name: ${{ needs.provision.outputs.acr_name }}
      image_tag: ${{ github.event.release.tag_name }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  restart-app:
    needs: [provision, build-and-deploy]
    environment: prod
    runs-on: ubuntu-latest
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Restart Web App
        run: |
          az webapp restart \
            --name ${{ needs.provision.outputs.webapp_name }} \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }}

      - name: Deployment Summary
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** $RELEASE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** ${{ needs.provision.outputs.webapp_url }}" >> $GITHUB_STEP_SUMMARY
